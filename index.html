<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>LevelUp Studio â€” Stats & Edit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ø³ØªØ§ÙŠÙ„ Ø¹Ø§Ù…: Ø£Ø³ÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ + Ù‡ÙŠØ¯Ø± ÙˆØ³Ø§ÙŠØ¯Ø¨Ø§Ø± Ù…ÙØµØºÙ‘Ø±ÙŠÙ† + Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø¨Ø±ØªÙ‚Ø§Ù†ÙŠ -->
  <style>
    :root{
      --bg:#000;
      --panel:#111;
      --muted:#222;
      --text:#fff;
      --line:#333;
      --active-bg:#fff;  /* Ø§Ù„Ø£Ø¨ÙŠØ¶ Ù„Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø· */
      --active-fg:#000;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù…ØµØºÙ‘Ø±) */
    .header{
      background:var(--bg);
      padding:6px 16px;      /* Ø£ØµØºØ± */
      height:50px;           /* Ø§Ø±ØªÙØ§Ø¹ ØµØºÙŠØ± Ø«Ø§Ø¨Øª */
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;
      position:sticky; top:0; z-index:50;
    }
    .header-left{display:flex;align-items:center;gap:12px}
    .header-left img{height:24px}
    .header-left h2{font-size:1.05rem;margin:0}
    .header-center{flex:1;display:flex;justify-content:center}
    .search-box{
      display:flex;align-items:center;
      background:#161616;border-radius:20px;
      padding:4px 10px;width:45%;
      max-width:520px; min-width:240px;
    }
    .search-box svg{width:20px;height:20px;stroke:#fff;flex-shrink:0;margin-left:6px}
    .search-box input{
      flex:1;background:transparent;border:0;outline:0;color:#fff;
      font-size:.85rem;padding:4px;
    }

    /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø³Ø§ÙŠØ¯Ø¨Ø§Ø± ÙŠÙ…ÙŠÙ† Ù…ØµØºÙ‘Ø±) */
    .container{display:flex;flex-direction:row-reverse;flex:1;min-height:0}
    .sidebar{
      width:180px;           /* Ø£ØµØºØ± Ù…Ù† 220 */
      border-left:1px solid var(--line);
      background:var(--bg);
      padding:15px 8px;
      display:flex;flex-direction:column;gap:12px;
      height:calc(100vh - 50px); position:sticky; top:50px;
    }
    .sidebar a{
      display:flex;align-items:center;gap:8px;
      text-decoration:none;color:var(--text);
      padding:8px;border-radius:6px; cursor:pointer;
      transition:background .2s;
      font-size:.95rem;
    }
    .sidebar a:hover{background:#444}
    .sidebar a.active{background:var(--active-bg); color:var(--active-fg); font-weight:bold}
    .sidebar svg{width:18px;height:18px;stroke:currentColor}

    .main{flex:1;padding:16px;min-width:0}

    /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª/Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
    .content-section{display:none}
    .content-section.active{display:block}

    /* Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª (Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„) */
    .table{
      width:100%; border-collapse:collapse; overflow:auto;
      background:var(--panel); border:1px solid var(--line); border-radius:8px;
    }
    .table th,.table td{
      padding:10px; border-bottom:1px solid var(--line); text-align:center;
      font-size:.92rem;
    }
    .table th{background:var(--muted); position:sticky; top:0}
    .thumb{width:96px; height:54px; border-radius:6px; object-fit:cover}

    .btn{
      background:var(--active-bg); color:var(--active-fg);
      border:none; padding:6px 10px; border-radius:6px; cursor:pointer;
      font-weight:600;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* ØµÙØ­Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
    .edit-wrap{
      background:var(--panel); border:1px solid var(--line); border-radius:10px;
      padding:16px; max-width:900px;
    }
    .edit-head{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;
    }
    .back{background:transparent;border:1px solid var(--line);color:var(--text);padding:6px 10px;border-radius:6px;cursor:pointer}
    .form-grid{
      display:grid; grid-template-columns:160px 1fr; gap:14px 16px;
      align-items:start;
    }
    .form-grid label{padding-top:8px; color:#ddd}
    .input, .textarea, .select{
      width:100%; background:#0d0d0d; color:#fff; border:1px solid var(--line);
      border-radius:8px; padding:10px; font-size:.95rem;
    }
    .textarea{min-height:120px; resize:vertical}
    .thumb-lg{width:260px; aspect-ratio:16/9; object-fit:cover; border-radius:8px; display:block}
    .help{font-size:.8rem; color:#aaa; margin-top:6px}
    @media (max-width: 800px){
      .form-grid{grid-template-columns:1fr}
      .form-grid label{padding-top:0}
    }
  </style>
</head>
<body>
  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ -->
  <div style="padding:10px;">
    <button id="loginBtn" class="btn" onclick="login()" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button id="logoutBtn" class="back" onclick="logout()" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- Ù†Ù„Ù Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ ÙƒÙ„Ù‡ Ù‡Ù†Ø§ -->
  <div id="studioArea" style="display:none;">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" stroke="#fff" fill="none" viewBox="0 0 24 24">
          <path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h2>LevelUp Studio</h2>
        <img src="levelup-icon.png" alt="Logo">
      </div>
      <div class="header-center">
        <div class="search-box">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M21 21l-4.35-4.35M16.65 10.65A6 6 0 1010.65 16.65 6 6 0 0016.65 10.65z"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input id="search" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„Ù‚Ø³Ù…...">
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <a class="active" onclick="openTab('stats', this)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <path d="M4 6h4v12H4zM10 10h4v8h-4zM16 4h4v14h-4z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        </a>
        <a onclick="openTab('edit', this)">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <path d="M12 20h9M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4L16.5 3.5z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        </a>
      </aside>

      <!-- Main -->
      <main class="main">
        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <section id="stats" class="content-section active">
          <h1>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
          <p>Ù‡Ù†Ø§ Ù‡ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆÙƒÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
        </section>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
        <section id="edit" class="content-section">
          <h1>âœï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</h1>

          <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª -->
          <div id="listView">
            <table class="table" id="videosTable">
              <thead>
                <tr>
                  <th>ØµÙˆØ±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- ØµÙØ­Ø©/ÙÙˆØ±Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
          <div id="editView" style="display:none;">
            <div class="edit-wrap">
              <div class="edit-head">
                <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h2>
                <button class="back" id="btnBack">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
              </div>
              <form id="formUpdate">
                <div class="form-grid">
                  <label for="editName">Ø§Ù„Ø§Ø³Ù…</label>
                  <input class="input" id="editName" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">

                  <label for="editCategory">Ø§Ù„Ù‚Ø³Ù…</label>
                  <div>
                    <img id="editThumbnail" class="thumb-lg" src="" alt="ØµÙˆØ±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ">
                    <div class="help">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ù‡Ù†Ø§:</div>
                    <input class="input" id="editCategory" type="text" placeholder="Ù…Ø«Ø§Ù„: ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§Øª / Ø«Ù‚Ø§ÙØ© Ø¹Ø§Ù…Ø©">
                  </div>

                  <label for="editTopic">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
                  <textarea class="textarea" id="editTopic" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹/Ø§Ù„ÙˆØµÙ Ù‡Ù†Ø§"></textarea>
                </div>

                <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
                  <button type="submit" class="btn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                  <button type="button" class="back" id="btnCancel">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
              </form>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div> <!-- end studioArea -->

  <!-- ğŸ”¥ Ø³ÙƒØ±Ø¨Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ + Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, 
      setPersistence, browserLocalPersistence, 
      onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDzoEzH1W6Z1lncab5Se8PObYFp6060oTk",
      authDomain: "levelup-d5f5c.firebaseapp.com",
      databaseURL: "https://levelup-d5f5c-default-rtdb.firebaseio.com/",
      projectId: "levelup-d5f5c",
      storageBucket: "levelup-d5f5c.appspot.com",
      messagingSenderId: "189128717624",
      appId: "1:189128717624:web:5a36bb4393eef1dca17dcd"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // âœ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Local Storage
    setPersistence(auth, browserLocalPersistence);

    const loginBtn   = document.getElementById("loginBtn");
    const logoutBtn  = document.getElementById("logoutBtn");
    const studioArea = document.getElementById("studioArea");

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function login() {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        if (user.email === "omar20227777@gmail.com") {
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
        } else {
          alert("Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âŒ");
          await signOut(auth);
        }
      } catch (err) {
        console.error(err);
        alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!");
      }
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    async function logout() {
      await signOut(auth);
      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
    }

    // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, (user) => {
      if (user && user.email === "omar20227777@gmail.com") {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";
        studioArea.style.display = "block";
        loadVideos();
      } else {
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        studioArea.style.display = "none";
      }
    });

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ---
    const tableBody   = document.querySelector("#videosTable tbody");
    const listView    = document.getElementById("listView");
    const editView    = document.getElementById("editView");
    const btnBack     = document.getElementById("btnBack");
    const btnCancel   = document.getElementById("btnCancel");
    const editName    = document.getElementById("editName");
    const editCategory= document.getElementById("editCategory");
    const editTopic   = document.getElementById("editTopic");
    const editThumb   = document.getElementById("editThumbnail");
    const searchInput = document.getElementById("search");

    let currentKey = null;
    let cache = [];

    async function getYoutubeInfo(videoId){
      try{
        const v = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=AIzaSyAeZ8GxeJ04NjKGFx7ABeq8khEkdAnvuVk`);
        const vData = await v.json();
        const sn = vData?.items?.[0]?.snippet;
        if(!sn) return null;
        return { title: sn.title, thumb: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` };
      }catch{ return null; }
    }

    function loadVideos(){
      onValue(ref(db, "videos"), async snapshot=>{
        const val = snapshot.val() || {};
        const entries = Object.entries(val).map(([key, item])=>({ key, ...item }));
        cache = await Promise.all(entries.map(async (it)=>{
          const info = await getYoutubeInfo(it.videoId);
          return {
            key: it.key,
            videoId: it.videoId,
            section: it.section || "",
            title: info?.title || it.name || "(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…)",
            thumb: info?.thumb || "",
            topic: it.topic || ""
          };
        }));
        renderTable(cache);
      });
    }

    function renderTable(rows){
      tableBody.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><img class="thumb" src="${r.thumb}" alt="thumb"></td>
          <td style="text-align:right">${escapeHtml(r.title)}</td>
          <td>${escapeHtml(r.section)}</td>
          <td><button class="btn" data-key="${r.key}">ØªØ¹Ø¯ÙŠÙ„</button></td>
        `;
        tableBody.appendChild(tr);
      });

      tableBody.querySelectorAll("button.btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const key = btn.getAttribute("data-key");
          const row = cache.find(x=>x.key===key);
          if(row) openEdit(row);
        });
      });
    }

    function openEdit(row){
      currentKey = row.key;
      editName.value = row.title || "";
      editCategory.value = row.section || "";
      editTopic.value = row.topic || "";
      editThumb.src = row.thumb;
      listView.style.display = "none";
      editView.style.display = "block";
    }

    function closeEdit(){
      currentKey = null;
      editView.style.display = "none";
      listView.style.display = "block";
    }

    btnBack.addEventListener("click", closeEdit);
    btnCancel.addEventListener("click", closeEdit);

    document.getElementById("formUpdate").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!currentKey) return;
      const data = {
        name: editName.value.trim(),
        section: editCategory.value.trim(),
        topic: editTopic.value.trim()
      };
      try{
        await update(ref(db, "videos/"+currentKey), data);
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª âœ…");
        closeEdit();
      }catch(err){
        console.error(err);
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      }
    });

    function escapeHtml(s=""){
      return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    window.login = login;
    window.logout = logout;
    window.openTab = function(tabId, el){
      document.querySelectorAll('.content-section').forEach(sec=>sec.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
      el.classList.add('active');
    }
  </script>
</body>
  </html>
